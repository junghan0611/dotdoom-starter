#!/bin/bash
# Emacs Interactive - Single Daemon Management
# ì˜¤ì§ í•˜ë‚˜ì˜ Emacs ë°ëª¬ë§Œ ì‹¤í–‰í•˜ë„ë¡ ë³´ì¥

DAEMON_PID_FILE="$HOME/.ei-daemon.pid"

check_daemon() {
    # emacsclientë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
    if emacsclient --eval 't' >/dev/null 2>&1; then
        return 0  # ë°ëª¬ ì‹¤í–‰ ì¤‘
    else
        return 1  # ë°ëª¬ ì—†ìŒ
    fi
}

kill_all_daemons() {
    # ëª¨ë“  Emacs ë°ëª¬ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
    emacsclient --eval "(kill-emacs)" 2>/dev/null || true
    pkill -f "emacs.*daemon" 2>/dev/null || true
    rm -f "$DAEMON_PID_FILE"
    sleep 1
}

start_daemon() {
    if check_daemon; then
        echo "âš ï¸  Emacs ë°ëª¬ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
        return 0
    fi
    
    echo "ğŸš€ Emacs ë°ëª¬ ì‹œì‘ ì¤‘..."
    # í˜¹ì‹œ ëª¨ë¥¼ ê¸°ì¡´ ë°ëª¬ë“¤ ì •ë¦¬
    kill_all_daemons
    
    emacs --daemon 2>/dev/null &
    echo $! > "$DAEMON_PID_FILE"
    
    # ë°ëª¬ ì‹œì‘ ëŒ€ê¸° (ìµœëŒ€ 10ì´ˆ)
    for i in {1..10}; do
        if check_daemon; then
            echo "âœ… ë°ëª¬ ì‹œì‘ ì™„ë£Œ"
            return 0
        fi
        sleep 1
    done
    
    echo "âŒ ë°ëª¬ ì‹œì‘ ì‹¤íŒ¨"
    return 1
}

case "$1" in
    ""|c|connect)
        if check_daemon; then
            emacsclient -t "${@:2}"
        else
            echo "ğŸ“¡ ë°ëª¬ì´ ì—†ìŠµë‹ˆë‹¤. ì‹œì‘ ì¤‘..."
            if start_daemon; then
                emacsclient -t "${@:2}"
            else
                echo "âŒ ì—°ê²° ì‹¤íŒ¨"
                exit 1
            fi
        fi
        ;;
    claude)
        if check_daemon; then
            emacsclient -t --eval "(progn (claude-code-mode 1) (message \"Claude Code í™œì„±í™”ë¨\"))" "${@:2}"
        else
            echo "ğŸ“¡ ë°ëª¬ì´ ì—†ìŠµë‹ˆë‹¤. ì‹œì‘ ì¤‘..."
            if start_daemon; then
                emacsclient -t --eval "(progn (claude-code-mode 1) (message \"Claude Code í™œì„±í™”ë¨\"))" "${@:2}"
            else
                echo "âŒ ì—°ê²° ì‹¤íŒ¨"
                exit 1
            fi
        fi
        ;;
    start)
        start_daemon
        ;;
    stop)
        echo "ğŸ›‘ ëª¨ë“  Emacs ë°ëª¬ ì¢…ë£Œ ì¤‘..."
        kill_all_daemons
        echo "âœ… ì¢…ë£Œ ì™„ë£Œ"
        ;;
    restart)
        echo "ğŸ”„ ë°ëª¬ ì¬ì‹œì‘ ì¤‘..."
        kill_all_daemons
        start_daemon
        ;;
    status)
        if check_daemon; then
            echo "âœ… Emacs ë°ëª¬ ì‹¤í–‰ ì¤‘"
        else
            echo "âŒ Emacs ë°ëª¬ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ"
        fi
        ;;
    *)
        echo "ì‚¬ìš©ë²•: ei [start|stop|restart|status|connect|c|claude] [íŒŒì¼...]"
        echo ""
        echo "ëª…ë ¹ì–´:"
        echo "  (ì—†ìŒ)   - ë°ëª¬ì— ì—°ê²° (ì—†ìœ¼ë©´ ìë™ ì‹œì‘)"
        echo "  claude   - Claude Code í™œì„±í™”í•˜ì—¬ ì—°ê²° ğŸ¯"
        echo "  start    - ë°ëª¬ ì‹œì‘ (ì¤‘ë³µ ë°©ì§€)"
        echo "  stop     - ëª¨ë“  ë°ëª¬ ì¢…ë£Œ"
        echo "  restart  - ë°ëª¬ ì¬ì‹œì‘"  
        echo "  status   - ë°ëª¬ ìƒíƒœ í™•ì¸"
        echo "  c        - ì—°ê²° (alias)"
        ;;
esac